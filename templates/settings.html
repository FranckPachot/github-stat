{{ define "settings" }}
<ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="connection-settings-tab" data-bs-toggle="tab" data-bs-target="#connection-settings" type="button" role="tab" aria-controls="connection-settings" aria-selected="true">Connection Settings</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="sleep-settings-tab" data-bs-toggle="tab" data-bs-target="#sleep-settings" type="button" role="tab" aria-controls="sleep-settings" aria-selected="false">Load Generator Settings</button>
    </li>
  </ul>
  <div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" id="connection-settings" role="tabpanel" aria-labelledby="connection-settings-tab">
      <div id="createConnection" class="mt-3">
        <div class="database-item mb-4 p-3 border rounded">
        <h3>Create database connection</h3>
        <form id="createForm" class="mt-4">
            <div class="mb-3">
              <label for="dbType" class="form-label">Select Database Type</label>
              <select class="form-select" id="dbType" name="dbType">
                <option value="mysql">MySQL</option>
                <option value="postgres">Postgres</option>
                <option value="mongodb">MongoDB</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="connectionString" class="form-label">Connection String</label>
              <input type="text" class="form-control" id="connectionString" name="connectionString" value="root:password@tcp(localhost:3306)/dataset">
            </div>
            <div class="mb-3" id="mongodbDatabaseField" style="display: none;">
              <label for="mongodbDatabase" class="form-label">MongoDB Database</label>
              <input type="text" class="form-control" id="mongodbDatabase" name="mongodbDatabase" value="dataset">
            </div>
            <button type="submit" class="btn btn-primary">Create</button>
            <div id="createMessage" class="mt-2"></div>
          </form>
        </div>
      </div>

    {{ template "database_list" . }}

    </div>
    <div class="tab-pane fade" id="sleep-settings" role="tabpanel" aria-labelledby="sleep-settings-tab">
      <h3 class="mt-3">Load Generator Settings</h3>
      <p>A separate go routine is opened for each connection to the database. In each go routine an infinite loop with queries to the database is executed. If the number of parallel connections is large and the number of CPUs is small, throttling and CPU queue may occur. To avoid this, add Sleep, which will be executed in each query cycle.</p>
      <form id="sleepSettingsForm" class="my-4">
        <div class="mb-3 my-3">
          <label for="mysqlSleep" class="form-label">MySQL Sleep (Millisecond)</label>
          <input type="number" class="form-control" id="mysqlSleep" name="mysqlSleep" value="{{ .LoadConfig.MySQLSleep }}">
        </div>
        <div class="mb-3 my-3">
          <label for="mongodbSleep" class="form-label">MongoDB Sleep (Millisecond)</label>
          <input type="number" class="form-control" id="mongodbSleep" name="mongodbSleep" value="{{ .LoadConfig.MongoDBSleep }}">
        </div>
        <div class="mb-3 my-3">
          <label for="postgresqlSleep" class="form-label">PostgreSQL Sleep (Millisecond)</label>
          <input type="number" class="form-control" id="postgresqlSleep" name="postgresqlSleep" value="{{ .LoadConfig.PostgresSleep }}">
        </div>
  
        <button type="submit" class="btn btn-primary">Save Sleep Settings</button>
      </form>
    </div>
</div>

<script>

    function updateDatabase(id) {
        const form = $(`#form-${id}`);
        const data = form.serialize();

        $.ajax({
        type: 'POST',
        url: `/update_db/${id}`,
        data: data,
        success: function(response) {
            alert('Database updated successfully');
        },
        error: function(xhr, status, error) {
            alert('Error: ' + error);
        }
        });
    }

    function deleteDatabase(id) {
        if (confirm('Are you sure you want to delete this database?')) {
            $.ajax({
                type: 'POST',
                url: `/delete_db`,
                data: { id: id }, // Передаем ID как часть данных запроса
                success: function(response) {
                    alert('Database deleted successfully');
                    loadDatabaseList();
                },
                error: function(xhr, status, error) {
                    alert('Error: ' + error);
                }
            });
        }
    }

    function loadDatabaseList() {
        $('#databaseList').load('/database_list #databaseList');
    }

    document.addEventListener('DOMContentLoaded', function() {
        const dbTypeSelect = document.getElementById('dbType');
        const mongodbDatabaseField = document.getElementById('mongodbDatabaseField');
        const connectionStringInput = document.getElementById('connectionString');

        dbTypeSelect.addEventListener('change', function() {
        if (dbTypeSelect.value === 'mongodb') {
            mongodbDatabaseField.style.display = 'block';
            connectionStringInput.value = 'mongodb://databaseAdmin:password@localhost:27017/';
        } else if (dbTypeSelect.value === 'mysql') {
            mongodbDatabaseField.style.display = 'none';
            connectionStringInput.value = 'root:password@tcp(localhost:3306)/dataset';
        } else if (dbTypeSelect.value === 'postgres') {
            mongodbDatabaseField.style.display = 'none';
            connectionStringInput.value = "user=postgres password='password' dbname=dataset host=localhost port=5432 sslmode=disable";
        } else {
            connectionStringInput.value = '';
        }
        });
    
      $('#createForm').on('submit', function(event) {
        event.preventDefault();
        const createMessage = $('#createMessage');
        createMessage.empty();
  
        $.ajax({
          type: 'POST',
          url: '/create_db',
          data: $(this).serialize(),
          success: function(response) {
            createMessage.css('color', 'green').text('Connection created successfully.');
            loadDatabaseList();
          },
          error: function(xhr, status, error) {
            createMessage.css('color', 'red').text('Error: ' + error);
          }
        });
      });
 
  
      // Load the database list when the page is loaded
    //   loadDatabaseList();
  
      $('#sleepSettingsForm').on('submit', function(event) {
        event.preventDefault();
        $.ajax({
          type: 'POST',
          url: '/settings_load',
          data: $(this).serialize(),
          success: function(response) {
            alert('Sleep settings saved successfully');
          },
          error: function(xhr, status, error) {
            alert('Error: ' + error);
          }
        });
      });
    });
</script>
{{ end }}
