{{ define "settings" }}
<ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="connection-settings-tab" data-bs-toggle="tab" data-bs-target="#connection-settings" type="button" role="tab" aria-controls="connection-settings" aria-selected="true">Connection Settings</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="sleep-settings-tab" data-bs-toggle="tab" data-bs-target="#sleep-settings" type="button" role="tab" aria-controls="sleep-settings" aria-selected="false">Load Generator Settings</button>
    </li>
  </ul>
  <div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" id="connection-settings" role="tabpanel" aria-labelledby="connection-settings-tab">
      <div id="createConnection" class="mt-3">
        <div class="database-item mb-4 p-3 border rounded">
        <h3>Create database connection</h3>
        <form id="createForm" class="mt-4">
            <div class="mb-3">
              <label for="dbType" class="form-label">Select Database Type</label>
              <select class="form-select" id="dbType" name="dbType">
                <option value="mysql">MySQL</option>
                <option value="postgres">Postgres</option>
                <option value="mongodb">MongoDB</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="connectionString" class="form-label">Connection String</label>
              <input type="text" class="form-control" id="connectionString" name="connectionString" value="root:password@tcp(localhost:3306)/dataset">
            </div>
            <div class="mb-3" id="mongodbDatabaseField" style="display: none;">
              <label for="mongodbDatabase" class="form-label">MongoDB Database</label>
              <input type="text" class="form-control" id="mongodbDatabase" name="mongodbDatabase" value="dataset">
            </div>
            <button type="submit" class="btn btn-primary">Create</button>
            <div id="createMessage" class="mt-2"></div>
          </form>
        </div>
      </div>

    {{ template "settings_databases" . }}

    </div>
    <div class="tab-pane fade" id="sleep-settings" role="tabpanel" aria-labelledby="sleep-settings-tab">

    {{ template "settings_load" . }}
      
    </div>
</div>

<script>

    function deleteSchema(id) {
        const form = $(`#formDatabases-${id}`)[0];
        const formData = new FormData(form);
        formData.append('delete_schema', 'true');

        fetch(`/update_db/${id}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log('deleteSchema:', data.connectionStatus);
            console.log('deleteSchema:', data.updateStatus);
            loadDatabaseList();
        })
        .catch(error => {
            console.error('Error:', error);
            $(`#connectionStatus-${id}`).text("Schema deletion failed");
        });
    }

    function createSchema(id) {
        const form = $(`#formDatabases-${id}`)[0];
        const formData = new FormData(form);
        formData.append('init_schema', 'true');

        fetch(`/update_db/${id}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log('createSchema: Connection: ', data.connectionStatus);
            console.log('createSchema: Update: ', data.updateStatus);
            loadDatabaseList();
        })
        .catch(error => {
            console.error('Error:', error);
            $(`#connectionStatus-${id}`).text("Schema creation failed");
        });
    }

    function importDataset(id) {
        const formData = new FormData();
        formData.append('action', 'import');

        fetch(`/manage-dataset/${id}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            $(`#datasetStatus-${id}`).text(`Dataset Status: ${data.datasetStatus}`).show();
            if (data.datasetStatus === 'Waiting') {
                $(`#importDataset-${id}`).hide();
                $(`#stopImportDataset-${id}`).show();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while adding the import task');
        });
    }

    function stopImportDataset(id) {
        const formData = new FormData();
        formData.append('action', 'stop');

        fetch(`/manage-dataset/${id}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                $(`#datasetStatus-${id}`).hide();
                $(`#importDataset-${id}`).show();
                $(`#stopImportDataset-${id}`).hide();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while stopping the import task');
        });
    }

    function updateDatabase(id) {
        const form = $(`#formDatabases-${id}`);
        const data = form.serialize();

        $.ajax({
            type: 'POST',
            url: `/update_db/${id}`,
            data: data,
            success: function(response) {
                loadDatabaseList();
            },
            error: function(xhr, status, error) {
                alert('Error: ' + error);
                $(`#connectionStatus-${id}`).text("Update failed");
            }
        });
    }

    function deleteDatabase(id) {
        if (confirm('Are you sure you want to delete this database?')) {
            $.ajax({
                type: 'POST',
                url: `/delete_db`,
                data: { id: id },
                success: function(response) {
                    alert('Database deleted successfully');
                    loadDatabaseList();
                },
                error: function(xhr, status, error) {
                    alert('Error: ' + error);
                }
            });
        }
    }

    function loadDatabaseList() {
        $('#databaseList').load('/database_list #databaseList');
    }

    document.addEventListener('DOMContentLoaded', function() {
        const dbTypeSelect = document.getElementById('dbType');
        const mongodbDatabaseField = document.getElementById('mongodbDatabaseField');
        const connectionStringInput = document.getElementById('connectionString');

        dbTypeSelect.addEventListener('change', function() {
        if (dbTypeSelect.value === 'mongodb') {
            mongodbDatabaseField.style.display = 'block';
            connectionStringInput.value = 'mongodb://root:password@localhost:27017/';
        } else if (dbTypeSelect.value === 'mysql') {
            mongodbDatabaseField.style.display = 'none';
            connectionStringInput.value = 'root:password@tcp(localhost:3306)/demo';
        } else if (dbTypeSelect.value === 'postgres') {
            mongodbDatabaseField.style.display = 'none';
            connectionStringInput.value = "user=postgres password='password' dbname=dataset host=localhost port=5432 sslmode=disable";
        } else {
            connectionStringInput.value = '';
        }
        });
    
        $('#createForm').on('submit', function(event) {
            event.preventDefault();
            const createMessage = $('#createMessage');
            createMessage.empty();

            $.ajax({
                type: 'POST',
                url: '/create_db',
                data: $(this).serialize(),
                success: function(response) {
                    createMessage.css('color', 'green').text('Connection created successfully.');
                    loadDatabaseList();
                },
                error: function(xhr, status, error) {
                    createMessage.css('color', 'red').text('Error: ' + error);
                }
            });
        });

        $('#sleepSettingsForm').on('submit', function(event) {
            event.preventDefault();
            $.ajax({
                type: 'POST',
                url: '/settings_load',
                data: $(this).serialize(),
                success: function(response) {
                    $('#statusMessage').html('<div class="alert alert-success">Sleep settings saved successfully</div>');
                },
                error: function(xhr, status, error) {
                    let errorMessage = error;
                    if (xhr.responseText) {
                        errorMessage = xhr.responseText;
                    }
                    $('#statusMessage').html('<div class="alert alert-danger">Error: ' + errorMessage + '</div>');
                }
            });
        });
    });
</script>
{{ end }}